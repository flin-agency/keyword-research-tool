<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keyword Research Tool</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#4F46E5",
            "background-light": "#F3F4F6",
            "background-dark": "#111827",
            "card-light": "#FFFFFF",
            "card-dark": "#1F2937",
            "text-light": "#111827",
            "text-dark": "#F9FAFB",
            "subtext-light": "#6B7280",
            "subtext-dark": "#9CA3AF",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "0.5rem",
          },
        },
      },
    };
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark">
  <div class="min-h-screen p-4 sm:p-6 md:p-8">
    <header class="text-center mb-8">
      <div class="flex justify-center items-center gap-4 mb-2">
        <span class="material-icons text-4xl text-primary">search</span>
        <h1 class="text-3xl sm:text-4xl font-bold text-text-light dark:text-text-dark">Keyword Research Tool</h1>
      </div>
      <p class="text-lg text-subtext-light dark:text-subtext-dark">Discover valuable keywords and topic clusters for your website</p>
    </header>

    <main class="max-w-7xl mx-auto space-y-8">
      <!-- Authentication Section -->
      <section class="bg-card-light dark:bg-card-dark p-6 rounded-lg shadow-sm">
        <h2 class="text-lg font-semibold mb-4 text-text-light dark:text-text-dark">Google Ads API Authentication:</h2>
        <div class="space-y-4">
          <button onclick="connectGoogle()" class="flex items-center gap-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">
            <span class="material-icons">link</span>
            Connect Google Account
          </button>
          <div id="tokenStatus" class="text-sm text-subtext-light dark:text-subtext-dark"></div>
          <div id="tokenMessage"></div>
        </div>

        <!-- Research Form -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <input
            id="urlInput"
            class="col-span-1 md:col-span-2 w-full p-3 rounded-md border border-gray-300 dark:border-gray-600 bg-card-light dark:bg-card-dark text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary focus:border-transparent"
            type="text"
            placeholder="Enter website URL (e.g., example.com)"
          />
          <div class="p-3 rounded-md border border-gray-300 dark:border-gray-600 bg-card-light dark:bg-card-dark text-text-light dark:text-text-dark">
            <span class="text-sm text-subtext-light dark:text-subtext-dark">Country:</span>
            <div class="font-semibold">ðŸ‡¨ðŸ‡­ Switzerland</div>
          </div>
          <div class="p-3 rounded-md border border-gray-300 dark:border-gray-600 bg-card-light dark:bg-card-dark text-text-light dark:text-text-dark">
            <span class="text-sm text-subtext-light dark:text-subtext-dark">Language:</span>
            <div class="font-semibold">ðŸ‡©ðŸ‡ª German</div>
          </div>
          <button id="startBtn" class="bg-primary text-white font-bold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors w-full md:w-auto">
            Start Research
          </button>
        </div>

        <!-- Progress Bar -->
        <div id="progressContainer" class="hidden mt-6">
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-8 overflow-hidden">
            <div id="progressFill" class="bg-primary h-full flex items-center justify-center text-white text-sm font-semibold transition-all duration-300" style="width: 0%">
              0%
            </div>
          </div>
          <p id="progressText" class="mt-2 text-center text-sm text-subtext-light dark:text-subtext-dark">Initializing...</p>
        </div>

        <div id="errorContainer" class="mt-4"></div>
      </section>

      <!-- Results Section -->
      <div id="results" style="display: none;">
        <!-- Summary -->
        <section class="bg-card-light dark:bg-card-dark p-6 rounded-lg shadow-sm">
          <h2 class="text-xl font-bold mb-4 text-text-light dark:text-text-dark">Summary</h2>
          <div id="summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-white"></div>
          <div class="mt-6 flex gap-4">
            <button onclick="exportResults('csv')" class="bg-gray-200 dark:bg-gray-700 text-text-light dark:text-text-dark font-semibold py-2 px-4 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
              Export CSV
            </button>
            <button onclick="exportResults('json')" class="bg-gray-200 dark:bg-gray-700 text-text-light dark:text-text-dark font-semibold py-2 px-4 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
              Export JSON
            </button>
          </div>
        </section>

        <!-- Clusters -->
        <section class="bg-card-light dark:bg-card-dark p-6 rounded-lg shadow-sm">
          <h2 class="text-xl font-bold mb-4 text-text-light dark:text-text-dark">Topic Clusters</h2>
          <div id="clusters" class="space-y-6"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // Global variables
    let currentJobId = null;
    let pollInterval = null;

    // Connect Google Account
    function connectGoogle() {
      window.location.href = '/api/auth/google';
    }

    // Start Research
    document.getElementById('startBtn').addEventListener('click', async () => {
      const url = document.getElementById('urlInput').value.trim();
      const country = document.getElementById('countrySelect').value;
      const language = document.getElementById('languageSelect').value;

      if (!url) {
        showError('Please enter a website URL');
        return;
      }

      // Reset UI
      document.getElementById('errorContainer').innerHTML = '';
      document.getElementById('results').style.display = 'none';
      document.getElementById('progressContainer').classList.remove('hidden');
      document.getElementById('startBtn').disabled = true;

      try {
        const response = await fetch('/api/research', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, country, language })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to start research');
        }

        const { job_id } = await response.json();
        currentJobId = job_id;
        pollInterval = setInterval(() => pollJobStatus(job_id), 2000);
      } catch (error) {
        showError(error.message);
        resetUI();
      }
    });

    // Poll job status
    async function pollJobStatus(jobId) {
      try {
        const response = await fetch(`/api/research/${jobId}`);
        const job = await response.json();

        updateProgress(job.progress || 0, job.step || 'Processing...');

        if (job.status === 'completed') {
          clearInterval(pollInterval);
          displayResults(job.data);
          resetUI();

          if (job.warnings && job.warnings.length > 0) {
            job.warnings.forEach(warning => showWarning(warning));
          }
        } else if (job.status === 'failed') {
          clearInterval(pollInterval);
          showError(job.error || 'Research failed');
          resetUI();
        }
      } catch (error) {
        clearInterval(pollInterval);
        showError(error.message);
        resetUI();
      }
    }

    // Update progress
    function updateProgress(progress, step) {
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('progressFill').textContent = `${progress}%`;
      document.getElementById('progressText').textContent = step;
    }

    // Display results
    function displayResults(data) {
      if (!data) return;

      // Summary
      document.getElementById('summary').innerHTML = `
        <div class="bg-indigo-500 p-4 rounded-lg text-center">
          <p class="text-4xl font-bold">${(data.totalKeywords || 0).toLocaleString()}</p>
          <p class="text-sm">Total Keywords</p>
        </div>
        <div class="bg-indigo-500 p-4 rounded-lg text-center">
          <p class="text-4xl font-bold">${(data.totalClusters || 0).toLocaleString()}</p>
          <p class="text-sm">Topic Clusters</p>
        </div>
        <div class="bg-indigo-500 p-4 rounded-lg text-center">
          <p class="text-4xl font-bold">${(data.totalSearchVolume || 0).toLocaleString()}</p>
          <p class="text-sm">Total Search Volume</p>
        </div>
        <div class="bg-indigo-500 p-4 rounded-lg text-center">
          <p class="text-4xl font-bold">${data.summary?.pagesScraped || 0}</p>
          <p class="text-sm">Pages Scanned</p>
        </div>
      `;

      // Clusters
      const clustersDiv = document.getElementById('clusters');
      clustersDiv.innerHTML = '';

      if (data.clusters && data.clusters.length > 0) {
        data.clusters.forEach((cluster, index) => {
          // Get competition badge classes
          const compLower = (cluster.avgCompetition || 'medium').toLowerCase();
          let competitionClasses = 'bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-100';
          if (compLower === 'low') {
            competitionClasses = 'bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-100';
          } else if (compLower === 'high') {
            competitionClasses = 'bg-red-200 dark:bg-red-800 text-red-800 dark:text-red-100';
          }

          const clusterHtml = `
            <div>
              <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-2">
                <h3 class="text-lg font-semibold text-text-light dark:text-text-dark">${index + 1}. ${cluster.pillarTopic}</h3>
                <div class="flex items-center gap-2">
                  ${cluster.aiEnhanced ? '<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-semibold px-2.5 py-0.5 rounded-full flex items-center gap-1"><span class="material-icons text-sm">auto_awesome</span> AI Enhanced</span>' : ''}
                  ${cluster.aiPriority ? '<span class="bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs font-semibold px-2.5 py-0.5 rounded-full flex items-center gap-1"><span class="material-icons text-sm">priority_high</span> Priority</span>' : ''}
                </div>
              </div>
              ${cluster.aiDescription ? `<p class="text-subtext-light dark:text-subtext-dark mb-3">${cluster.aiDescription}</p>` : ''}
              <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-subtext-light dark:text-subtext-dark mb-4">
                <span><span class="font-semibold text-text-light dark:text-text-dark">${(cluster.totalSearchVolume || 0).toLocaleString()}</span> searches/mo</span>
                <span><span class="font-semibold text-text-light dark:text-text-dark">${cluster.keywords?.length || 0}</span> keywords</span>
                <span>Score: <span class="font-semibold text-text-light dark:text-text-dark">${cluster.clusterValueScore || 0}/100</span></span>
              </div>
              ${cluster.aiContentStrategy ? `<div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-4"><p class="text-sm text-text-light dark:text-text-dark"><span class="font-semibold">Content Strategy:</span> ${cluster.aiContentStrategy}</p></div>` : ''}
              <div class="flex justify-between items-center mb-4">
                <div></div>
                <span class="${competitionClasses} text-xs font-bold px-3 py-1 rounded-full uppercase">${cluster.avgCompetition}</span>
              </div>
              <div id="cluster-${index}" class="overflow-x-auto">
                <table class="w-full text-sm text-left text-subtext-light dark:text-subtext-dark">
                  <thead class="text-xs text-subtext-light dark:text-subtext-dark uppercase bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th scope="col" class="px-6 py-3">Keyword</th>
                      <th scope="col" class="px-6 py-3">Search Volume</th>
                      <th scope="col" class="px-6 py-3">Competition</th>
                      <th scope="col" class="px-6 py-3">CPC Range</th>
                    </tr>
                  </thead>
                  <tbody class="text-text-light dark:text-text-dark">
                    ${(cluster.keywords || []).slice(0, 10).map((kw, kidx) => `
                      <tr class="${kidx % 2 === 0 ? 'bg-card-light dark:bg-card-dark' : 'bg-gray-50 dark:bg-gray-800'} border-b dark:border-gray-700">
                        <td class="px-6 py-4 font-medium">${kw.keyword}</td>
                        <td class="px-6 py-4">${(kw.searchVolume || 0).toLocaleString()}</td>
                        <td class="px-6 py-4 uppercase">${kw.competition}</td>
                        <td class="px-6 py-4">$${(kw.cpc || 0).toFixed(2)} - $${(kw.cpcHigh || 0).toFixed(2)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                ${cluster.keywords?.length > 10 ? `<div class="pt-4 text-center"><a href="#" class="text-primary hover:underline font-semibold">+ ${cluster.keywords.length - 10} more keywords</a></div>` : ''}
              </div>
            </div>
          `;
          clustersDiv.innerHTML += clusterHtml;
        });
      }

      document.getElementById('results').style.display = 'block';
    }

    // Export results
    async function exportResults(format) {
      if (!currentJobId) return;

      try {
        const response = await fetch(`/api/research/${currentJobId}/export?format=${format}`);
        if (!response.ok) throw new Error('Failed to export results');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `keywords-${currentJobId.slice(0, 8)}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        showError(error.message);
      }
    }

    // Show error
    function showError(message) {
      document.getElementById('errorContainer').innerHTML = `
        <div class="bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-md text-sm flex items-center gap-2">
          <span class="material-icons">error</span>
          ${message}
        </div>
      `;
    }

    // Show warning
    function showWarning(message) {
      const warning = document.createElement('div');
      warning.className = 'bg-yellow-100 dark:bg-yellow-900/50 border border-yellow-200 dark:border-yellow-700 text-yellow-700 dark:text-yellow-300 px-4 py-3 rounded-md text-sm flex items-center gap-2 mt-2';
      warning.innerHTML = `<span class="material-icons">warning</span>${message}`;
      document.getElementById('errorContainer').appendChild(warning);
    }

    // Reset UI
    function resetUI() {
      document.getElementById('startBtn').disabled = false;
      document.getElementById('progressContainer').classList.add('hidden');
    }

    // Check authentication status on load
    window.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const success = urlParams.get('success');
      const error = urlParams.get('error');
      const message = urlParams.get('message');
      const tokenMessage = document.getElementById('tokenMessage');
      const tokenStatus = document.getElementById('tokenStatus');

      if (success === 'true') {
        tokenMessage.innerHTML = '<div class="bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 px-4 py-3 rounded-md text-sm flex items-center gap-2"><span class="material-icons">check_circle</span>' + (message || 'Google account connected successfully!') + '</div>';
        tokenStatus.innerHTML = '<div class="bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 px-4 py-3 rounded-md text-sm flex items-center gap-2"><span class="material-icons">check_circle</span>Connected - Google Ads API enabled</div>';
        window.history.replaceState({}, document.title, window.location.pathname);
      } else if (error) {
        tokenMessage.innerHTML = '<div class="bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-md text-sm flex items-center gap-2"><span class="material-icons">error</span>Authentication failed: ' + decodeURIComponent(error) + '</div>';
      }

      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();

        if (data.configured) {
          tokenStatus.innerHTML = '<div class="bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 px-4 py-3 rounded-md text-sm flex items-center gap-2"><span class="material-icons">check_circle</span>Connected - Google Ads API enabled</div>';
        } else if (!data.hasClientId || !data.hasClientSecret) {
          tokenStatus.innerHTML = '<div class="bg-yellow-100 dark:bg-yellow-900/50 border border-yellow-200 dark:border-yellow-700 text-yellow-700 dark:text-yellow-300 px-4 py-3 rounded-md text-sm flex items-center gap-2"><span class="material-icons">warning</span>Please configure Client ID and Client Secret in .env file first</div>';
        } else {
          tokenStatus.textContent = 'Click "Connect Google Account" to authenticate';
        }
      } catch (error) {
        console.error('Failed to check API status');
      }
    });

    // Make functions global
    window.exportResults = exportResults;
    window.connectGoogle = connectGoogle;
  </script>
</body>
</html>